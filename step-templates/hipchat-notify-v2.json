{
  "Id": "ActionTemplates-3",
  "Name": "Notify Hipchat",
  "Description": "Notify a HipChat room of a deployment outcome.",
  "ActionType": "Octopus.Script",
  "Version": 2,
  "Properties": {
    "Octopus.Action.Script.ScriptBody": "#---------\r\n$apitoken = $OctopusParameters['AuthToken']\r\n$roomid = $OctopusParameters['RoomId']\r\n$messageText = \"(successful)\"\r\n$color = 'green'\r\n\r\nif ($Octopus.Deployment.Error) {\r\n        $messageText = \"(failed)\"\r\n        $color = 'red'\r\n}\r\n\r\n$message = New-Object PSObject \r\n$message | Add-Member -MemberType NoteProperty -Name color -Value $color\r\n$message | Add-Member -MemberType NoteProperty -Name message -Value \"$messageText $($OctopusParameters['Octopus.Project.Name']) [v$($OctopusParameters['Octopus.Release.Number'])] deployed to $($OctopusParameters['Octopus.Environment.Name'])  on $($OctopusParameters['Octopus.Machine.Name'])\"\r\n$message | Add-Member -MemberType NoteProperty -Name notify -Value $false\r\n$message | Add-Member -MemberType NoteProperty -Name message_format -Value text\r\n\r\n\r\nif ($OctopusParameters['NotificationText']) {\r\n    $message = $OctopusParameters['NotificationText']\r\n    $colour = $OctopusParameters['NotificationColor']\r\n}        \r\n\r\n#Do the HTTP POST to HipChat\r\n$uri = \"https://api.hipchat.com/v2/room/$roomid/notification?auth_token=$apitoken\"\r\n$postBody = ConvertTo-Json -InputObject $message\r\n$postStr = [System.Text.Encoding]::UTF8.GetBytes($postBody)\r\n\r\n$webRequest = [System.Net.WebRequest]::Create($uri)\r\n$webRequest.ContentType = \"application/json\"\r\n$webrequest.ContentLength = $postStr.Length\r\n$webRequest.Method = \"POST\"\r\n\r\n$requestStream = $webRequest.GetRequestStream()\r\n$requestStream.Write($postStr, 0,$postStr.length)\r\n$requestStream.Close()\r\n\r\n[System.Net.WebResponse] $resp = $webRequest.GetResponse()\r\n$rs = $resp.GetResponseStream()\r\n\r\n[System.IO.StreamReader] $sr = New-Object System.IO.StreamReader -argumentList $rs\r\n$sr.ReadToEnd()"
  },
  "SensitiveProperties": {},
  "Parameters": [
    {
      "Name": "AuthToken",
      "Label": "Auth Token",
      "HelpText": "HipChat authentication token for a user who can post notifications to rooms",
      "DefaultValue": null
    },
    {
      "Name": "RoomId",
      "Label": "Room",
      "HelpText": "The room name that you wish to post a notification to",
      "DefaultValue": null
    },
    {
      "Name": "NotificationText",
      "Label": "Notification Text",
      "HelpText": "An optional notification value. If not supplied you will receive a notification taking the following form:\n\n(successful) Project [version] deployed to Environment on Machine\n(failed) Project [version] deployed to Environment on Machine",
      "DefaultValue": null
    },
    {
      "Name": "NotificationColor",
      "Label": "Notification Color",
      "HelpText": "The color for the notification for the room. Default messages will receive green success, and red failure.",
      "DefaultValue": null
    }
  ],
  "LastModifiedOn": "2014-07-25T07:05:44.012+00:00",
  "LastModifiedBy": "stephen.godbold",
  "$Meta": {
    "ExportedAt": "2014-07-25T07:05:50.733Z",
    "OctopusVersion": "2.4.10.235",
    "Type": "ActionTemplate"
  }
}